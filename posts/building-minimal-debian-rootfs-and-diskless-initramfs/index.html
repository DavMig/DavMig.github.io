<!doctype html><html lang=en-us><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><script type=text/javascript src=https://latest.cactus.chat/cactus.js></script><link rel=stylesheet href=https://latest.cactus.chat/style.css type=text/css><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Building a Minimal Debian Rootfs and Diskless Initramfs | Zaft Memory Core </title><link rel=canonical href=https://davmig.github.io/posts/building-minimal-debian-rootfs-and-diskless-initramfs/><meta name=description content="Welcome to Zaft Memory Core — a personal archive for my thoughts, ideas, and technical explorations. This platform is where I document my journey, from code snippets and project insights to creative concepts worth revisiting. It’s more than just a collection—it's a reflection of how I think, organize, and approach challenges. Designed to be simple yet effective, Zaft Memory Core keeps everything I need in one place, ready to evolve alongside my skills and interests. Because every idea deserves structure."><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:url" content="https://davmig.github.io/posts/building-minimal-debian-rootfs-and-diskless-initramfs/"><meta property="og:site_name" content="Zaft Memory Core "><meta property="og:title" content="Building a Minimal Debian Rootfs and Diskless Initramfs"><meta property="og:description" content="Building a Minimal Debian Rootfs and a Diskless Initramfs Introduction In previous articles, I described how to deploy a functional Kubernetes cluster.
The problem appears shortly after: host system maintenance.
A traditional OS, installed on disk and updated over time, introduces configuration drift, hard-to-reproduce states, and risky upgrade procedures.
If the goal is a Kubernetes cluster with minimal maintenance, the underlying system must be:
reproducible, immutable, disposable, and able to boot without external dependencies. This article focuses on building a diskless operating system, fully loaded into RAM, based on a read-only root filesystem, and bootstrapped using a fully controlled initramfs."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-12-16T09:00:00+00:00"><meta property="article:modified_time" content="2025-12-16T09:00:00+00:00"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Initramfs"><meta property="article:tag" content="Debian"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="Diskless"><meta name=twitter:card content="summary"><meta name=twitter:title content="Building a Minimal Debian Rootfs and Diskless Initramfs"><meta name=twitter:description content="Building a Minimal Debian Rootfs and a Diskless Initramfs Introduction In previous articles, I described how to deploy a functional Kubernetes cluster.
The problem appears shortly after: host system maintenance.
A traditional OS, installed on disk and updated over time, introduces configuration drift, hard-to-reproduce states, and risky upgrade procedures.
If the goal is a Kubernetes cluster with minimal maintenance, the underlying system must be:
reproducible, immutable, disposable, and able to boot without external dependencies. This article focuses on building a diskless operating system, fully loaded into RAM, based on a read-only root filesystem, and bootstrapped using a fully controlled initramfs."><link rel=stylesheet href=https://davmig.github.io/css/styles.c05d68261bf086a9d7713c4f8a6215a3601608e267a816a7ee58f139b3d1aae51222aae2081c8e0c6bd35e1334773b7a16283022f31f92afd93bb37e5e822e66.css integrity="sha512-wF1oJhvwhqnXcTxPimIVo2AWCOJnqBan7ljxObPRquUSIqriCByODGvTXhM0dzt6FigwIvMfkq/ZO7N+XoIuZg=="><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://davmig.github.io/images/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=false"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","false")}</script></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick='$("html, body").animate({scrollTop:0},"fast")' style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>Main</a></li><li><a href=/posts>Writings</a></li><li><a href=/tags>Tags</a></li><li><a href=/about>About</a></li><li><a href=/posts/>Posts</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://davmig.github.io/posts/k8s-part3-fluxcd-installation/ aria-label=Previous><i class="fas fa-chevron-left" aria-hidden=true onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fdavmig.github.io%2fposts%2fbuilding-minimal-debian-rootfs-and-diskless-initramfs%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fdavmig.github.io%2fposts%2fbuilding-minimal-debian-rootfs-and-diskless-initramfs%2f&text=Building%20a%20Minimal%20Debian%20Rootfs%20and%20Diskless%20Initramfs" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fdavmig.github.io%2fposts%2fbuilding-minimal-debian-rootfs-and-diskless-initramfs%2f&title=Building%20a%20Minimal%20Debian%20Rootfs%20and%20Diskless%20Initramfs" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fdavmig.github.io%2fposts%2fbuilding-minimal-debian-rootfs-and-diskless-initramfs%2f&is_video=false&description=Building%20a%20Minimal%20Debian%20Rootfs%20and%20Diskless%20Initramfs" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Building%20a%20Minimal%20Debian%20Rootfs%20and%20Diskless%20Initramfs&body=Check out this article: https%3a%2f%2fdavmig.github.io%2fposts%2fbuilding-minimal-debian-rootfs-and-diskless-initramfs%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fdavmig.github.io%2fposts%2fbuilding-minimal-debian-rootfs-and-diskless-initramfs%2f&title=Building%20a%20Minimal%20Debian%20Rootfs%20and%20Diskless%20Initramfs" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fdavmig.github.io%2fposts%2fbuilding-minimal-debian-rootfs-and-diskless-initramfs%2f&title=Building%20a%20Minimal%20Debian%20Rootfs%20and%20Diskless%20Initramfs" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fdavmig.github.io%2fposts%2fbuilding-minimal-debian-rootfs-and-diskless-initramfs%2f&name=Building%20a%20Minimal%20Debian%20Rootfs%20and%20Diskless%20Initramfs&description=%3ch1%20id%3d%22building-a-minimal-debian-rootfs-and-a-diskless-initramfs%22%3eBuilding%20a%20Minimal%20Debian%20Rootfs%20and%20a%20Diskless%20Initramfs%3c%2fh1%3e%0a%3ch2%20id%3d%22introduction%22%3eIntroduction%3c%2fh2%3e%0a%3cp%3eIn%20previous%20articles%2c%20I%20described%20how%20to%20deploy%20a%20functional%20Kubernetes%20cluster.%3cbr%3e%0aThe%20problem%20appears%20shortly%20after%3a%20%3cstrong%3ehost%20system%20maintenance%3c%2fstrong%3e.%3c%2fp%3e%0a%3cp%3eA%20traditional%20OS%2c%20installed%20on%20disk%20and%20updated%20over%20time%2c%20introduces%20configuration%20drift%2c%20hard-to-reproduce%20states%2c%20and%20risky%20upgrade%20procedures.%3cbr%3e%0aIf%20the%20goal%20is%20a%20%3cstrong%3eKubernetes%20cluster%20with%20minimal%20maintenance%3c%2fstrong%3e%2c%20the%20underlying%20system%20must%20be%3a%3c%2fp%3e%0a%3cul%3e%0a%3cli%3ereproducible%2c%3c%2fli%3e%0a%3cli%3eimmutable%2c%3c%2fli%3e%0a%3cli%3edisposable%2c%3c%2fli%3e%0a%3cli%3eand%20able%20to%20boot%20without%20external%20dependencies.%3c%2fli%3e%0a%3c%2ful%3e%0a%3cp%3eThis%20article%20focuses%20on%20building%20a%20%3cstrong%3ediskless%20operating%20system%3c%2fstrong%3e%2c%20fully%20loaded%20into%20RAM%2c%20based%20on%20a%20read-only%20root%20filesystem%2c%20and%20bootstrapped%20using%20a%20fully%20controlled%20initramfs.%3c%2fp%3e" aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fdavmig.github.io%2fposts%2fbuilding-minimal-debian-rootfs-and-diskless-initramfs%2f&t=Building%20a%20Minimal%20Debian%20Rootfs%20and%20Diskless%20Initramfs" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div><div id=toc><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#build-overview>Build Overview</a></li><li><a href=#1-workspace-preparation>1. Workspace Preparation</a></li><li><a href=#2-creating-the-minimal-debian-rootfs>2. Creating the Minimal Debian Rootfs</a></li><li><a href=#3-rootfs-preparation-and-kernel-extraction>3. Rootfs Preparation and Kernel Extraction</a><ul><li><a href=#31-essential-directories>3.1 Essential Directories</a></li><li><a href=#32-temporary-mounts>3.2 Temporary Mounts</a></li><li><a href=#33-installing-base-utilities>3.3 Installing Base Utilities</a></li><li><a href=#34-kernel-and-modules-extraction>3.4 Kernel and Modules Extraction</a></li><li><a href=#35-cleanup-and-size-reduction>3.5 Cleanup and Size Reduction</a></li></ul></li><li><a href=#4-creating-an-immutable-rootfs-squashfs>4. Creating an Immutable Rootfs (SquashFS)</a></li><li><a href=#5-initramfs-construction>5. Initramfs Construction</a><ul><li><a href=#51-required-directory-structure>5.1 Required Directory Structure</a></li><li><a href=#52-busybox>5.2 BusyBox</a></li><li><a href=#53-kernel-modules>5.3 Kernel Modules</a></li><li><a href=#54-rootfs-and-kernel-placement>5.4 Rootfs and Kernel Placement</a></li></ul></li><li><a href=#6-the-init-script>6. The <code>init</code> Script</a></li><li><a href=#7-initramfs-packaging>7. Initramfs Packaging</a></li><li><a href=#8-testing-with-qemu>8. Testing with QEMU</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">Building a Minimal Debian Rootfs and Diskless Initramfs</h1><div class=meta><div class=postdate><time datetime="2025-12-16 09:00:00 +0000 UTC" itemprop=datePublished>2025-12-16</time></div><div class=article-read-time><i class="far fa-clock"></i>
4 minute read</div><div class=article-category><i class="fas fa-archive"></i>
<a class=category-link href=/categories/notes>notes</a>
,
<a class=category-link href=/categories/linux>linux</a>
,
<a class=category-link href=/categories/kubernetes>kubernetes</a></div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/linux rel=tag>linux</a>
,
<a class=tag-link href=/tags/initramfs rel=tag>initramfs</a>
,
<a class=tag-link href=/tags/debian rel=tag>debian</a>
,
<a class=tag-link href=/tags/kubernetes rel=tag>kubernetes</a>
,
<a class=tag-link href=/tags/diskless rel=tag>diskless</a></div></div></header><div class=content itemprop=articleBody><h1 id=building-a-minimal-debian-rootfs-and-a-diskless-initramfs>Building a Minimal Debian Rootfs and a Diskless Initramfs</h1><h2 id=introduction>Introduction</h2><p>In previous articles, I described how to deploy a functional Kubernetes cluster.<br>The problem appears shortly after: <strong>host system maintenance</strong>.</p><p>A traditional OS, installed on disk and updated over time, introduces configuration drift, hard-to-reproduce states, and risky upgrade procedures.<br>If the goal is a <strong>Kubernetes cluster with minimal maintenance</strong>, the underlying system must be:</p><ul><li>reproducible,</li><li>immutable,</li><li>disposable,</li><li>and able to boot without external dependencies.</li></ul><p>This article focuses on building a <strong>diskless operating system</strong>, fully loaded into RAM, based on a read-only root filesystem, and bootstrapped using a fully controlled initramfs.</p><p>This needs to be stated clearly: the initramfs part is poorly documented.<br>Most tutorials found online are incomplete or incorrect. Reaching a stable solution requires trial, failure, and a solid understanding of the Linux boot process.</p><hr><h2 id=prerequisites>Prerequisites</h2><ul><li>A Debian or Ubuntu system with root access.</li><li>Required tools:<ul><li><code>debootstrap</code></li><li><code>busybox-static</code></li><li><code>mksquashfs</code></li><li><code>cpio</code></li><li><code>zstd</code></li><li><code>qemu-system-x86_64</code></li></ul></li><li>Basic knowledge of shell scripting and Linux boot internals.</li></ul><hr><h2 id=build-overview>Build Overview</h2><p>The build process produces three artifacts:</p><ul><li>a <strong>minimal Debian root filesystem</strong>,</li><li>a <strong>custom initramfs</strong> loaded by the kernel at boot,</li><li>a matching <strong>Linux kernel image</strong>.</li></ul><p>At boot time:</p><ol><li>The kernel is loaded by firmware or a hypervisor.</li><li>The kernel loads the initramfs into memory.</li><li>The initramfs prepares a minimal runtime environment.</li><li>The SquashFS root filesystem is mounted in RAM.</li><li>Control is handed over to <code>/sbin/init</code> inside the root filesystem.</li></ol><p>No <code>root=</code> kernel parameter is required, as the root filesystem is not a traditional block device.</p><hr><h2 id=1-workspace-preparation>1. Workspace Preparation</h2><p>Before building anything, separate concerns clearly:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>mkdir -p build/rootfs build/initramfs out
</span></span></code></pre></div><ul><li><code>build/rootfs</code> will contain the Debian root filesystem.</li><li><code>build/initramfs</code> is used to assemble the initramfs.</li><li><code>out</code> stores final build artifacts.</li></ul><p>This separation greatly simplifies debugging and iteration.</p><hr><h2 id=2-creating-the-minimal-debian-rootfs>2. Creating the Minimal Debian Rootfs</h2><p>The root filesystem is generated using <code>debootstrap</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>debootstrap --variant<span style=color:#ff79c6>=</span>minbase trixie build/rootfs
</span></span></code></pre></div><ul><li><code>minbase</code> installs only essential packages.</li><li>No unnecessary services or tooling.</li></ul><p>At this point, the rootfs is <strong>not bootable</strong>. It is only a filesystem tree.</p><hr><h2 id=3-rootfs-preparation-and-kernel-extraction>3. Rootfs Preparation and Kernel Extraction</h2><p>This step prepares the root filesystem and retrieves the kernel without installing it directly.</p><h3 id=31-essential-directories>3.1 Essential Directories</h3><p>Some directories must exist explicitly:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>mkdir -p /proc /sys /dev /run /tmp /mnt
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>chmod <span style=color:#bd93f9>1777</span> /tmp /run
</span></span></code></pre></div><p>Without these, package management tools and system services behave unpredictably.</p><hr><h3 id=32-temporary-mounts>3.2 Temporary Mounts</h3><p>To allow package installation and hardware detection:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>mount -t proc proc /proc
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>mount -t sysfs sys /sys
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>mount -t devtmpfs none /dev
</span></span></code></pre></div><p>These mounts are temporary and removed later.</p><hr><h3 id=33-installing-base-utilities>3.3 Installing Base Utilities</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>apt update
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>apt install --yes --no-install-recommends <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#f1fa8c></span>  bash <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#f1fa8c></span>  coreutils <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#f1fa8c></span>  util-linux <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#f1fa8c></span>  procps <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#f1fa8c></span>  systemd-sysv <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#f1fa8c></span>  iproute2 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span><span style=color:#f1fa8c></span>  udev
</span></span></code></pre></div><p>The goal is not comfort, but functionality:</p><ul><li>clean boot,</li><li>device handling,</li><li>minimal diagnostics.</li></ul><hr><h3 id=34-kernel-and-modules-extraction>3.4 Kernel and Modules Extraction</h3><p><code>linux-image-amd64</code> is a meta-package.<br>First, identify the actual kernel package:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>apt-cache depends linux-image-amd64
</span></span></code></pre></div><p>Then extract it without installing:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>dpkg-deb -x linux-image-*.deb /tmp/kernel
</span></span></code></pre></div><p>This provides:</p><ul><li>the <code>vmlinuz</code> kernel image,</li><li>the kernel modules.</li></ul><p>All without polluting the root filesystem.</p><hr><h3 id=35-cleanup-and-size-reduction>3.5 Cleanup and Size Reduction</h3><p>To keep the system minimal:</p><ul><li>remove documentation,</li><li>strip binaries,</li><li>delete unnecessary kernel drivers.</li></ul><p>This reduces both size and failure surface.</p><hr><h2 id=4-creating-an-immutable-rootfs-squashfs>4. Creating an Immutable Rootfs (SquashFS)</h2><p>The root filesystem is compressed into SquashFS:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>mksquashfs build/rootfs out/rootfs.squashfs -comp xz
</span></span></code></pre></div><p>SquashFS provides:</p><ul><li>read-only semantics,</li><li>excellent compression,</li><li>reliable mounting from initramfs.</li></ul><p>This is a key part of the immutable design.</p><hr><h2 id=5-initramfs-construction>5. Initramfs Construction</h2><p>The initramfs is the minimal environment the kernel boots into.</p><h3 id=51-required-directory-structure>5.1 Required Directory Structure</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>mkdir -p build/initramfs/<span style=color:#ff79c6>{</span>bin,sbin,etc,proc,sys,dev,tmp,mnt,lib<span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>These directories are expected by the kernel and by the init process.</p><hr><h3 id=52-busybox>5.2 BusyBox</h3><p>BusyBox provides most Unix utilities in a single binary:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>cp /usr/bin/busybox build/initramfs/bin
</span></span></code></pre></div><p>A statically linked BusyBox is strongly recommended to avoid runtime dependencies.</p><hr><h3 id=53-kernel-modules>5.3 Kernel Modules</h3><p>Copy the required kernel modules:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>cp -r build/rootfs/tmp/kernel/usr/lib/modules build/initramfs/lib
</span></span></code></pre></div><p>The <code>loop</code> and <code>squashfs</code> modules are mandatory to mount the root filesystem.</p><hr><h3 id=54-rootfs-and-kernel-placement>5.4 Rootfs and Kernel Placement</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>cp out/rootfs.squashfs build/initramfs/
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>cp build/rootfs/tmp/kernel/boot/vmlinuz-* out/vmlinuz
</span></span></code></pre></div><p>At this stage, all required boot components are present.</p><hr><h2 id=6-the-init-script>6. The <code>init</code> Script</h2><p>The <code>init</code> script is the first user-space process started by the kernel:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>#!/bin/sh
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6></span><span style=color:#8be9fd;font-style:italic>set</span> -e
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>modprobe loop <span style=color:#ff79c6>||</span> <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;loop builtin&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>modprobe squashfs <span style=color:#ff79c6>||</span> <span style=color:#8be9fd;font-style:italic>exec</span> sh
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>mount -t proc proc /proc
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>mount -t sysfs sys /sys
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>mount -t devtmpfs none /dev
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>mount -t tmpfs tmpfs /mnt/rootfs
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>mount -o loop /rootfs.squashfs /mnt/rootfs
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#8be9fd;font-style:italic>exec</span> switch_root /mnt/rootfs /sbin/init
</span></span></code></pre></div><p>Its responsibilities are minimal but critical:</p><ul><li>prepare the environment,</li><li>mount the final root filesystem,</li><li>transfer control to the real init system.</li></ul><p>Most broken tutorials fail at this exact point.</p><hr><h2 id=7-initramfs-packaging>7. Initramfs Packaging</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd;font-style:italic>cd</span> build/initramfs
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>find . -print0 | cpio --null -ov --format<span style=color:#ff79c6>=</span>newc | zstd -o ../../out/initramfs.img
</span></span></code></pre></div><ul><li><code>newc</code> format is required by the kernel.</li><li>Archive structure must be exact.</li></ul><hr><h2 id=8-testing-with-qemu>8. Testing with QEMU</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>qemu-system-x86_64 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#f1fa8c></span>  -m 6G <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#f1fa8c></span>  -kernel out/vmlinuz <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#f1fa8c></span>  -initrd out/initramfs.img <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#f1fa8c></span>  -append <span style=color:#f1fa8c>&#34;console=ttyS0&#34;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#f1fa8c></span>  -nographic
</span></span></code></pre></div><p>Key points:</p><ul><li>No <code>root=/dev/...</code> parameter.</li><li>Rootfs mounting is handled by initramfs.</li><li>Output is redirected to the serial console.</li></ul><hr><h2 id=conclusion>Conclusion</h2><p>This process produces a system that is:</p><ul><li>minimal,</li><li>diskless,</li><li>immutable,</li><li>fully reproducible.</li></ul><p>This is not an end goal, but a <strong>solid foundation</strong> for building a truly self-managed Kubernetes cluster, capable of bootstrapping, upgrading, and repairing itself without external infrastructure.</p><p>The next logical step is integrating kubelet and the container runtime directly into this diskless model.<br>At that point, the operating system stops being a liability and becomes a controlled, replaceable component.</p></div></article><div class=blog-post-comments><div id=cactus-comments-thread><script>initComments({node:document.getElementById("cactus-comments-thread"),defaultHomeserverUrl:"https://matrix.cactus.chat:8448",serverName:"cactus.chat",siteName:"your_cactus_comments_sitename",commentSectionId:"/posts/building-minimal-debian-rootfs-and-diskless-initramfs/"})</script></div></div><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Main</a></li><li><a href=/posts>Writings</a></li><li><a href=/tags>Tags</a></li><li><a href=/about>About</a></li><li><a href=/posts/>Posts</a></li></ul></div><div id=toc-footer style=display:none><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#build-overview>Build Overview</a></li><li><a href=#1-workspace-preparation>1. Workspace Preparation</a></li><li><a href=#2-creating-the-minimal-debian-rootfs>2. Creating the Minimal Debian Rootfs</a></li><li><a href=#3-rootfs-preparation-and-kernel-extraction>3. Rootfs Preparation and Kernel Extraction</a><ul><li><a href=#31-essential-directories>3.1 Essential Directories</a></li><li><a href=#32-temporary-mounts>3.2 Temporary Mounts</a></li><li><a href=#33-installing-base-utilities>3.3 Installing Base Utilities</a></li><li><a href=#34-kernel-and-modules-extraction>3.4 Kernel and Modules Extraction</a></li><li><a href=#35-cleanup-and-size-reduction>3.5 Cleanup and Size Reduction</a></li></ul></li><li><a href=#4-creating-an-immutable-rootfs-squashfs>4. Creating an Immutable Rootfs (SquashFS)</a></li><li><a href=#5-initramfs-construction>5. Initramfs Construction</a><ul><li><a href=#51-required-directory-structure>5.1 Required Directory Structure</a></li><li><a href=#52-busybox>5.2 BusyBox</a></li><li><a href=#53-kernel-modules>5.3 Kernel Modules</a></li><li><a href=#54-rootfs-and-kernel-placement>5.4 Rootfs and Kernel Placement</a></li></ul></li><li><a href=#6-the-init-script>6. The <code>init</code> Script</a></li><li><a href=#7-initramfs-packaging>7. Initramfs Packaging</a></li><li><a href=#8-testing-with-qemu>8. Testing with QEMU</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fdavmig.github.io%2fposts%2fbuilding-minimal-debian-rootfs-and-diskless-initramfs%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fdavmig.github.io%2fposts%2fbuilding-minimal-debian-rootfs-and-diskless-initramfs%2f&text=Building%20a%20Minimal%20Debian%20Rootfs%20and%20Diskless%20Initramfs" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fdavmig.github.io%2fposts%2fbuilding-minimal-debian-rootfs-and-diskless-initramfs%2f&title=Building%20a%20Minimal%20Debian%20Rootfs%20and%20Diskless%20Initramfs" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fdavmig.github.io%2fposts%2fbuilding-minimal-debian-rootfs-and-diskless-initramfs%2f&is_video=false&description=Building%20a%20Minimal%20Debian%20Rootfs%20and%20Diskless%20Initramfs" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Building%20a%20Minimal%20Debian%20Rootfs%20and%20Diskless%20Initramfs&body=Check out this article: https%3a%2f%2fdavmig.github.io%2fposts%2fbuilding-minimal-debian-rootfs-and-diskless-initramfs%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fdavmig.github.io%2fposts%2fbuilding-minimal-debian-rootfs-and-diskless-initramfs%2f&title=Building%20a%20Minimal%20Debian%20Rootfs%20and%20Diskless%20Initramfs" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fdavmig.github.io%2fposts%2fbuilding-minimal-debian-rootfs-and-diskless-initramfs%2f&title=Building%20a%20Minimal%20Debian%20Rootfs%20and%20Diskless%20Initramfs" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fdavmig.github.io%2fposts%2fbuilding-minimal-debian-rootfs-and-diskless-initramfs%2f&name=Building%20a%20Minimal%20Debian%20Rootfs%20and%20Diskless%20Initramfs&description=%3ch1%20id%3d%22building-a-minimal-debian-rootfs-and-a-diskless-initramfs%22%3eBuilding%20a%20Minimal%20Debian%20Rootfs%20and%20a%20Diskless%20Initramfs%3c%2fh1%3e%0a%3ch2%20id%3d%22introduction%22%3eIntroduction%3c%2fh2%3e%0a%3cp%3eIn%20previous%20articles%2c%20I%20described%20how%20to%20deploy%20a%20functional%20Kubernetes%20cluster.%3cbr%3e%0aThe%20problem%20appears%20shortly%20after%3a%20%3cstrong%3ehost%20system%20maintenance%3c%2fstrong%3e.%3c%2fp%3e%0a%3cp%3eA%20traditional%20OS%2c%20installed%20on%20disk%20and%20updated%20over%20time%2c%20introduces%20configuration%20drift%2c%20hard-to-reproduce%20states%2c%20and%20risky%20upgrade%20procedures.%3cbr%3e%0aIf%20the%20goal%20is%20a%20%3cstrong%3eKubernetes%20cluster%20with%20minimal%20maintenance%3c%2fstrong%3e%2c%20the%20underlying%20system%20must%20be%3a%3c%2fp%3e%0a%3cul%3e%0a%3cli%3ereproducible%2c%3c%2fli%3e%0a%3cli%3eimmutable%2c%3c%2fli%3e%0a%3cli%3edisposable%2c%3c%2fli%3e%0a%3cli%3eand%20able%20to%20boot%20without%20external%20dependencies.%3c%2fli%3e%0a%3c%2ful%3e%0a%3cp%3eThis%20article%20focuses%20on%20building%20a%20%3cstrong%3ediskless%20operating%20system%3c%2fstrong%3e%2c%20fully%20loaded%20into%20RAM%2c%20based%20on%20a%20read-only%20root%20filesystem%2c%20and%20bootstrapped%20using%20a%20fully%20controlled%20initramfs.%3c%2fp%3e" aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fdavmig.github.io%2fposts%2fbuilding-minimal-debian-rootfs-and-diskless-initramfs%2f&t=Building%20a%20Minimal%20Debian%20Rootfs%20and%20Diskless%20Initramfs" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick='return $("#nav-footer").toggle(),!1' aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=toc-toggle class=icon href=# onclick='return $("#toc-footer").toggle(),!1' aria-label=TOC><i class="fas fa-list fa-lg" aria-hidden=true></i> TOC</a>
<a id=share-toggle class=icon href=# onclick='return $("#share-footer").toggle(),!1' aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2025 Zaft Memory Core</div><div class=footer-right><nav><ul><li><a href=/>Main</a></li><li><a href=/posts>Writings</a></li><li><a href=/tags>Tags</a></li><li><a href=/about>About</a></li><li><a href=/posts/>Posts</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script><script src=/js/code-copy.js></script></html>