<!doctype html><html lang=en-us><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><script type=text/javascript src=https://latest.cactus.chat/cactus.js></script><link rel=stylesheet href=https://latest.cactus.chat/style.css type=text/css><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Installation of Kubernetes on Debian Part 1 - Control Plane | Zaft Memory Core </title><link rel=canonical href=https://davmig.github.io/posts/k8s-part1-control-plane-installation-on-debian/><meta name=description content="Welcome to Zaft Memory Core — a personal archive for my thoughts, ideas, and technical explorations. This platform is where I document my journey, from code snippets and project insights to creative concepts worth revisiting. It’s more than just a collection—it's a reflection of how I think, organize, and approach challenges. Designed to be simple yet effective, Zaft Memory Core keeps everything I need in one place, ready to evolve alongside my skills and interests. Because every idea deserves structure."><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:url" content="https://davmig.github.io/posts/k8s-part1-control-plane-installation-on-debian/"><meta property="og:site_name" content="Zaft Memory Core "><meta property="og:title" content="Installation of Kubernetes on Debian Part 1 - Control Plane"><meta property="og:description" content="Rationale At work, we are currently deploying GKEs for our applications. Today, containerization is no longer something I see as optional but a necessity due to the value it provides—though it’s often necessary to work on team organization first to get the most out of it, but that’s a topic for another post.
However, mastering such a system is not within everyone’s reach. Implementing technical governance around this system is no easy task, and those who implement it generally agree—it’s complex and requires real expertise to design and deploy the various stacks with technology choices suited to the context."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-05-16T09:00:00+00:00"><meta property="article:modified_time" content="2025-05-16T09:00:00+00:00"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="K8s"><meta name=twitter:card content="summary"><meta name=twitter:title content="Installation of Kubernetes on Debian Part 1 - Control Plane"><meta name=twitter:description content="Rationale At work, we are currently deploying GKEs for our applications. Today, containerization is no longer something I see as optional but a necessity due to the value it provides—though it’s often necessary to work on team organization first to get the most out of it, but that’s a topic for another post.
However, mastering such a system is not within everyone’s reach. Implementing technical governance around this system is no easy task, and those who implement it generally agree—it’s complex and requires real expertise to design and deploy the various stacks with technology choices suited to the context."><link rel=stylesheet href=https://davmig.github.io/css/styles.c05d68261bf086a9d7713c4f8a6215a3601608e267a816a7ee58f139b3d1aae51222aae2081c8e0c6bd35e1334773b7a16283022f31f92afd93bb37e5e822e66.css integrity="sha512-wF1oJhvwhqnXcTxPimIVo2AWCOJnqBan7ljxObPRquUSIqriCByODGvTXhM0dzt6FigwIvMfkq/ZO7N+XoIuZg=="><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://davmig.github.io/images/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=false"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","false")}</script></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick='$("html, body").animate({scrollTop:0},"fast")' style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>Main</a></li><li><a href=/posts>Writings</a></li><li><a href=/tags>Tags</a></li><li><a href=/about>About</a></li><li><a href=/posts/>Posts</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://davmig.github.io/about/ aria-label=Previous><i class="fas fa-chevron-left" aria-hidden=true onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class=icon href=https://davmig.github.io/posts/k8s-part3-fluxcd-installation/ aria-label=Next><i class="fas fa-chevron-right" aria-hidden=true onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fdavmig.github.io%2fposts%2fk8s-part1-control-plane-installation-on-debian%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fdavmig.github.io%2fposts%2fk8s-part1-control-plane-installation-on-debian%2f&text=Installation%20of%20Kubernetes%20on%20Debian%20Part%201%20-%20Control%20Plane" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fdavmig.github.io%2fposts%2fk8s-part1-control-plane-installation-on-debian%2f&title=Installation%20of%20Kubernetes%20on%20Debian%20Part%201%20-%20Control%20Plane" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fdavmig.github.io%2fposts%2fk8s-part1-control-plane-installation-on-debian%2f&is_video=false&description=Installation%20of%20Kubernetes%20on%20Debian%20Part%201%20-%20Control%20Plane" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Installation%20of%20Kubernetes%20on%20Debian%20Part%201%20-%20Control%20Plane&body=Check out this article: https%3a%2f%2fdavmig.github.io%2fposts%2fk8s-part1-control-plane-installation-on-debian%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fdavmig.github.io%2fposts%2fk8s-part1-control-plane-installation-on-debian%2f&title=Installation%20of%20Kubernetes%20on%20Debian%20Part%201%20-%20Control%20Plane" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fdavmig.github.io%2fposts%2fk8s-part1-control-plane-installation-on-debian%2f&title=Installation%20of%20Kubernetes%20on%20Debian%20Part%201%20-%20Control%20Plane" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fdavmig.github.io%2fposts%2fk8s-part1-control-plane-installation-on-debian%2f&name=Installation%20of%20Kubernetes%20on%20Debian%20Part%201%20-%20Control%20Plane&description=%3ch2%20id%3d%22rationale%22%3eRationale%3c%2fh2%3e%0a%3cp%3eAt%20work%2c%20we%20are%20currently%20deploying%20GKEs%20for%20our%20applications.%20Today%2c%20containerization%20is%20no%20longer%20something%20I%20see%20as%20optional%20but%20a%20necessity%20due%20to%20the%20value%20it%20provides%e2%80%94though%20it%26rsquo%3bs%20often%20necessary%20to%20work%20on%20team%20organization%20first%20to%20get%20the%20most%20out%20of%20it%2c%20but%20that%26rsquo%3bs%20a%20topic%20for%20another%20post.%3c%2fp%3e%0a%3cp%3eHowever%2c%20mastering%20such%20a%20system%20is%20not%20within%20everyone%26rsquo%3bs%20reach.%20Implementing%20technical%20governance%20around%20this%20system%20is%20no%20easy%20task%2c%20and%20those%20who%20implement%20it%20generally%20agree%e2%80%94it%26rsquo%3bs%20complex%20and%20requires%20real%20expertise%20to%20design%20and%20deploy%20the%20various%20stacks%20with%20technology%20choices%20suited%20to%20the%20context.%3c%2fp%3e" aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fdavmig.github.io%2fposts%2fk8s-part1-control-plane-installation-on-debian%2f&t=Installation%20of%20Kubernetes%20on%20Debian%20Part%201%20-%20Control%20Plane" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div><div id=toc><nav id=TableOfContents><ul><li><a href=#rationale>Rationale</a></li><li><a href=#lets-get-started>Let&rsquo;s get started</a></li><li><a href=#pre-requisites>Pre-requisites</a><ul><li><a href=#disable-swap>Disable swap</a></li><li><a href=#installing-runtime>Installing runtime</a></li></ul></li><li><a href=#installing-with-kubeadm>Installing with Kubeadm</a><ul><li><a href=#install-using-the-kubernetes-repo>Install using the Kubernetes repo</a></li><li><a href=#cluster-creation>Cluster creation</a></li><li><a href=#flannel>Flannel</a></li></ul></li></ul></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">Installation of Kubernetes on Debian Part 1 - Control Plane</h1><div class=meta><div class=postdate><time datetime="2025-05-16 09:00:00 +0000 UTC" itemprop=datePublished>2025-05-16</time></div><div class=article-read-time><i class="far fa-clock"></i>
10 minute read</div><div class=article-category><i class="fas fa-archive"></i>
<a class=category-link href=/categories/notes>notes</a>
,
<a class=category-link href=/categories/k8s>k8s</a>
,
<a class=category-link href=/categories/kubernetes>kubernetes</a></div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/kubernetes rel=tag>kubernetes</a>
,
<a class=tag-link href=/tags/k8s rel=tag>k8s</a></div></div></header><div class=content itemprop=articleBody><h2 id=rationale>Rationale</h2><p>At work, we are currently deploying GKEs for our applications. Today, containerization is no longer something I see as optional but a necessity due to the value it provides—though it&rsquo;s often necessary to work on team organization first to get the most out of it, but that&rsquo;s a topic for another post.</p><p>However, mastering such a system is not within everyone&rsquo;s reach. Implementing technical governance around this system is no easy task, and those who implement it generally agree—it&rsquo;s complex and requires real expertise to design and deploy the various stacks with technology choices suited to the context.</p><p>So, I quickly became curious and today I&rsquo;m diving into the technical side of things, namely setting up a vanilla Kubernetes on a VM to get started.</p><p>I&rsquo;m documenting the different steps of this installation and the various issues encountered.</p><h2 id=lets-get-started>Let&rsquo;s get started</h2><p>So I head to the official <a href=https://kubernetes.io/docs/setup/>Kubernetes website</a> to get started and end up in the <a href=https://kubernetes.io/docs/setup/learning-environment/minikube/>Learning Environments</a> section. However, this doesn’t excite me much—even though it’s a simple and quick way to begin.</p><p>Instead, I’ll try a more &ldquo;from scratch&rdquo; installation using tools typically used for &ldquo;production&rdquo; Kubernetes deployments. Everything starts <a href=https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/>here</a>.</p><h2 id=pre-requisites>Pre-requisites</h2><p>Kubeadm is the toolbox to bootstrap a Kubernetes cluster. One thing to note is that it&rsquo;s compiled with dynamic linking rather than static, so a glibc is required somewhere (Alpine uses musl), which is why I’ll start with a Debian base.</p><p>The goal here isn&rsquo;t to restate what&rsquo;s already in the official documentation, but we&rsquo;ll make sure to have at least 2 CPUs on the VM, a supported kernel, and unique MAC addresses for each VM used.</p><h3 id=disable-swap>Disable swap</h3><p>We also ensure that swap is disabled on the VM.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>david@node:~$ sudo swapoff -a
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>david@node:~$ sudo sed -i <span style=color:#f1fa8c>&#39;/swap/ s/^/#/&#39;</span> /etc/fstab
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>david@node:~$ grep swap /etc/fstab
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#6272a4>## swap was on /dev/sda5 during installation</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#6272a4>#UUID=19d62f10-216b-4978-a8a3-bc8c0a4caa21 none            swap    sw              0       0</span>
</span></span></code></pre></div><h3 id=installing-runtime>Installing runtime</h3><p>We&rsquo;ll install containerd, which is the default runtime recommended for Kubernetes. Since this is our first deployment, we’ll use it. Kubernetes uses the CRI (Container Runtime Interface) protocol to communicate with the runtime. Out of curiosity, I looked into it—it’s simply a gRPC API using protocol buffers. You can view the <a href=https://github.com/kubernetes/cri-api/blob/c75ef5b/pkg/apis/runtime/v1/api.proto>proto implementation here</a>.</p><p>So we install containerd via the official Docker repository, as stated in the official docs.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4># Add Docker&#39;s official GPG key:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>sudo apt-get update
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>sudo apt-get install ca-certificates curl
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>sudo install -m <span style=color:#bd93f9>0755</span> -d /etc/apt/keyrings
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>sudo curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>sudo chmod a+r /etc/apt/keyrings/docker.asc
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4># Add the repository to Apt sources:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#f1fa8c></span>  <span style=color:#f1fa8c>&#34;deb [arch=</span><span style=color:#ff79c6>$(</span>dpkg --print-architecture<span style=color:#ff79c6>)</span><span style=color:#f1fa8c> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian \
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#f1fa8c>  </span><span style=color:#ff79c6>$(</span>. /etc/os-release <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$VERSION_CODENAME</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c> stable&#34;</span> | <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#f1fa8c></span>  sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>sudo apt-get update
</span></span></code></pre></div><p>I then install only containerd, not docker-engine, docker-cli, etc.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>david@node:~$ sudo apt-get install  containerd.io
</span></span></code></pre></div><p>We verify that it is working.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>david@node:~$ sudo systemctl status containerd
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>● containerd.service - containerd container runtime
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>     Loaded: loaded <span style=color:#ff79c6>(</span>/lib/systemd/system/containerd.service; enabled; preset: enabled<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>     Active: active <span style=color:#ff79c6>(</span>running<span style=color:#ff79c6>)</span> since Fri 2025-05-16 22:13:12 CEST; 1min 28s ago
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>       Docs: https://containerd.io
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    Process: <span style=color:#bd93f9>1207</span> <span style=color:#8be9fd;font-style:italic>ExecStartPre</span><span style=color:#ff79c6>=</span>/sbin/modprobe overlay <span style=color:#ff79c6>(</span><span style=color:#8be9fd;font-style:italic>code</span><span style=color:#ff79c6>=</span>exited, <span style=color:#8be9fd;font-style:italic>status</span><span style=color:#ff79c6>=</span>0/SUCCESS<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>   Main PID: <span style=color:#bd93f9>1208</span> <span style=color:#ff79c6>(</span>containerd<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>      Tasks: <span style=color:#bd93f9>8</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>     Memory: 20.1M
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        CPU: 269ms
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>     CGroup: /system.slice/containerd.service
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>             └─1208 /usr/bin/containerd
</span></span></code></pre></div><p>Next, we configure containerd to use systemd as the cgroup driver.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>david@node:~$ sudo vi  /etc/containerd/config.toml
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>david@node:~$ tail !$
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>tail /etc/containerd/config.toml
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#6272a4>#[debug]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#6272a4>#  address = &#34;/run/containerd/debug.sock&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4>#  uid = 0</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4>#  gid = 0</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4>#  level = &#34;info&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#ff79c6>[</span>plugins.<span style=color:#f1fa8c>&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd.runtimes.runc<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>  <span style=color:#ff79c6>[</span>plugins.<span style=color:#f1fa8c>&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd.runtimes.runc.options<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#8be9fd;font-style:italic>SystemdCgroup</span> <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>true</span>
</span></span></code></pre></div><p>Also, make sure the CRI plugin is not disabled.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>david@node:~$ grep -i  CRI /etc/containerd/config.toml
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#8be9fd;font-style:italic>disabled_plugins</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;cri&#34;</span><span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>david@node:~$ sudo sed -i <span style=color:#f1fa8c>&#39;/disabled_plug/ s/^/#/&#39;</span> /etc/containerd/config.toml
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>david@node:~$ grep -i cri !$
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>grep -i cri /etc/containerd/config.toml
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#6272a4>#disabled_plugins = [&#34;cri&#34;]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>david@node:~$ <span style=color:#6272a4># on restart</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>david@node:~$ sudo systemctl restart containerd
</span></span></code></pre></div><p>We also need to enable IP packet forwarding as per the documentation.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># sysctl params required by setup, params persist across reboots</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>cat <span style=color:#f1fa8c>&lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#f1fa8c>net.ipv4.ip_forward = 1
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#f1fa8c>EOF</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#6272a4># Apply sysctl params without reboot</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>sudo sysctl --system
</span></span></code></pre></div><h2 id=installing-with-kubeadm>Installing with Kubeadm</h2><p>We will install 3 binaries (from the doc):</p><ul><li>kubelet: the component that runs on all machines in your cluster and starts pods and containers.</li><li>kubeadm: the command to bootstrap the cluster.</li><li>kubectl: the CLI to interact with your cluster.</li></ul><h3 id=install-using-the-kubernetes-repo>Install using the Kubernetes repo</h3><p>We add the necessary packages (from the doc).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>sudo apt-get update
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4># apt-transport-https may be a dummy package; if so, you can skip that package</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>sudo apt-get install -y apt-transport-https ca-certificates curl gpg
</span></span></code></pre></div><p>Download the public signing key for the Kubernetes package repositories. The same signing key is used for all repositories so you can disregard the version in the URL:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># If the directory `/etc/apt/keyrings` does not exist, it should be created before the curl command, read the note below.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4># sudo mkdir -p -m 755 /etc/apt/keyrings</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.33/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
</span></span></code></pre></div><p>Add the appropriate Kubernetes apt repository. Please note that this repository have packages only for Kubernetes 1.33; for other Kubernetes minor versions, you need to change the Kubernetes minor version in the URL to match your desired minor version (you should also check that you are reading the documentation for the version of Kubernetes that you plan to install).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4># This overwrites any existing configuration in /etc/apt/sources.list.d/kubernetes.list</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#39;deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.33/deb/ /&#39;</span> | sudo tee /etc/apt/sources.list.d/kubernetes.list
</span></span></code></pre></div><p>Update the apt package index, install kubelet, kubeadm and kubectl, and pin their version:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>david@node:~$ sudo apt-get update
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>sudo apt-get install -y kubelet kubeadm kubectl
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>sudo apt-mark hold kubelet kubeadm kubectl
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#ff79c6>[</span>...<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>kubelet <span style=color:#8be9fd;font-style:italic>set</span> on hold.
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>kubeadm <span style=color:#8be9fd;font-style:italic>set</span> on hold.
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>kubectl <span style=color:#8be9fd;font-style:italic>set</span> on hold.
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>david@node:~$
</span></span></code></pre></div><p>According to the official documentation <a href=https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/>here</a>, we can now launch the kubelet, but it will crash in a loop. That’s okay—we’re here to break things!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>sudo systemctl <span style=color:#8be9fd;font-style:italic>enable</span> --now kubelet
</span></span></code></pre></div><p>Our tools are now installed and the pre-requisites completed. We move on to cluster creation.</p><h3 id=cluster-creation>Cluster creation</h3><p>Before creating the cluster, we must choose which CNI plugin to use. The CNI plugin will have a default CIDR used for the pods. I’ll use the Flannel CNI, which has a default CIDR of 10.244.0.0/16.</p><p>We launch the cluster creation.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>david@node:~$ sudo kubeadm --pod-network-cidr<span style=color:#ff79c6>=</span>10.244.0.0/16 init
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#ff79c6>[</span>init<span style=color:#ff79c6>]</span> Using Kubernetes version: v1.33.1
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>[</span>preflight<span style=color:#ff79c6>]</span> Running pre-flight checks
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#ff79c6>[</span>preflight<span style=color:#ff79c6>]</span> Pulling images required <span style=color:#ff79c6>for</span> setting up a Kubernetes cluster
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#ff79c6>[</span>...<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>Your Kubernetes control-plane has initialized successfully!
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#ff79c6>[</span>...<span style=color:#ff79c6>]</span>
</span></span></code></pre></div><p>We apply the Kubeconfig so we can use kubectl.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>david@node:~$ mkdir -p <span style=color:#8be9fd;font-style:italic>$HOME</span>/.kube
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  sudo cp -i /etc/kubernetes/admin.conf <span style=color:#8be9fd;font-style:italic>$HOME</span>/.kube/config
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>  sudo chown <span style=color:#ff79c6>$(</span>id -u<span style=color:#ff79c6>)</span>:<span style=color:#ff79c6>$(</span>id -g<span style=color:#ff79c6>)</span> <span style=color:#8be9fd;font-style:italic>$HOME</span>/.kube/config
</span></span></code></pre></div><p>And now we can finally use kubectl!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>david@node:~$ sudo kubectl get pods -n kube-system
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>E0516 22:55:21.639859    <span style=color:#bd93f9>6259</span> memcache.go:265<span style=color:#ff79c6>]</span> <span style=color:#f1fa8c>&#34;Unhandled Error&#34;</span> <span style=color:#8be9fd;font-style:italic>err</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;couldn&#39;t get current server API group list: Get \&#34;http://localhost:8080/api?timeout=32s\&#34;: dial tcp [::1]:8080: connect: connection refused&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>[</span>...<span style=color:#ff79c6>]</span>
</span></span></code></pre></div><p>And nothing works.</p><p>We debug, debug, debug&mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>david@node:~$ sudo crictl ps
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>WARN<span style=color:#ff79c6>[</span>0000<span style=color:#ff79c6>]</span> Config <span style=color:#f1fa8c>&#34;/etc/crictl.yaml&#34;</span> does not exist, trying next: <span style=color:#f1fa8c>&#34;/usr/bin/crictl.yaml&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>WARN<span style=color:#ff79c6>[</span>0000<span style=color:#ff79c6>]</span> runtime connect using default endpoints: <span style=color:#ff79c6>[</span>unix:///run/containerd/containerd.sock unix:///run/crio/crio.sock unix:///var/run/cri-dockerd.sock<span style=color:#ff79c6>]</span>. As the default settings are now deprecated, you should <span style=color:#8be9fd;font-style:italic>set</span> the endpoint instead.
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>WARN<span style=color:#ff79c6>[</span>0000<span style=color:#ff79c6>]</span> Image connect using default endpoints: <span style=color:#ff79c6>[</span>unix:///run/containerd/containerd.sock unix:///run/crio/crio.sock unix:///var/run/cri-dockerd.sock<span style=color:#ff79c6>]</span>. As the default settings are now deprecated, you should <span style=color:#8be9fd;font-style:italic>set</span> the endpoint instead.
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>CONTAINER           IMAGE               CREATED             STATE               NAME                ATTEMPT             POD ID              POD                   NAMESPACE
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>e637040f3fcb0       398c985c0d950       <span style=color:#bd93f9>16</span> seconds ago      Running             kube-scheduler      <span style=color:#bd93f9>5</span>                   9be7f15b8e617       kube-scheduler-node   kube-system
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>f1f2375d5f77e       499038711c081       <span style=color:#bd93f9>3</span> minutes ago       Running             etcd                <span style=color:#bd93f9>2</span>                   a77b2ea9c2673       etcd-node             kube-system
</span></span></code></pre></div><p>It&rsquo;s just a warning, but we need to fix it—so we specify which socket crictl should use to connect to containerd.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>david@node:~$ <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;runtime-endpoint: \&#34;unix:///run/containerd/containerd.sock\&#34;&#34;</span> | sudo tee /etc/crictl.yaml
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>runtime-endpoint: <span style=color:#f1fa8c>&#34;unix:///run/containerd/containerd.sock&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>david@node:~$ sudo crictl ps
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>CONTAINER           IMAGE               CREATED             STATE               NAME                ATTEMPT             POD ID              POD                   NAMESPACE
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>0f7a76f04e3bd       c6ab243b29f82       <span style=color:#bd93f9>18</span> seconds ago      Running             kube-apiserver      <span style=color:#bd93f9>6</span>                   6ccd1bc12f650       kube-apiserver-node   kube-system
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>f6f080638599c       499038711c081       <span style=color:#bd93f9>2</span> minutes ago       Running             etcd                <span style=color:#bd93f9>3</span>                   3f44a329afb3f       etcd-node             kube-system
</span></span></code></pre></div><p>Now we see that containers are restarting in a loop.</p><p>I notice that the etcd server is restarting in a loop</p><pre tabindex=0><code>{&#34;level&#34;:&#34;info&#34;,&#34;ts&#34;:&#34;2025-05-16T21:05:05.837939Z&#34;,&#34;caller&#34;:&#34;osutil/interrupt_unix.go:64&#34;,&#34;msg&#34;:&#34;received signal; shutting down&#34;,&#34;signal&#34;:&#34;terminated&#34;}
</code></pre><p>Something is killing it. I thought about Linux OOM, but that’s not it. I then checked the kubelet, which is supposed to manage static pod startup.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>david@node:~$ sudo systemctl status kubelet
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>● kubelet.service - kubelet: The Kubernetes Node Agent
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>     Loaded: loaded <span style=color:#ff79c6>(</span>/lib/systemd/system/kubelet.service; enabled; preset: enabled<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    Drop-In: /usr/lib/systemd/system/kubelet.service.d
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>             └─10-kubeadm.conf
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>     Active: active <span style=color:#ff79c6>(</span>running<span style=color:#ff79c6>)</span> since Fri 2025-05-16 22:50:07 CEST; 16min ago
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>       Docs: https://kubernetes.io/docs/
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>   Main PID: <span style=color:#bd93f9>3267</span> <span style=color:#ff79c6>(</span>kubelet<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>      Tasks: <span style=color:#bd93f9>12</span> <span style=color:#ff79c6>(</span>limit: 9484<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>     Memory: 40.4M
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        CPU: 32.188s
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>     CGroup: /system.slice/kubelet.service
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>             └─3267 /usr/bin/kubelet --bootstrap-kubeconfig<span style=color:#ff79c6>=</span>/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig<span style=color:#ff79c6>=</span>/etc/kubernetes/kubelet.conf --config<span style=color:#ff79c6>=</span>/var/lib/kubelet/config.yaml --conta&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>May <span style=color:#bd93f9>16</span> 23:06:27 node kubelet<span style=color:#ff79c6>[</span>3267<span style=color:#ff79c6>]</span>: I0516 23:06:27.828196    <span style=color:#bd93f9>3267</span> status_manager.go:895<span style=color:#ff79c6>]</span> <span style=color:#f1fa8c>&#34;Failed to get status for pod&#34;</span> <span style=color:#8be9fd;font-style:italic>podUID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;ae7c601e440a2ba4ecda4af0c0b43098&#34;</span> <span style=color:#8be9fd;font-style:italic>pod</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;kube-system/kube-sc&gt;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#f1fa8c>May 16 23:06:27 node kubelet[3267]: I0516 23:06:27.828324    3267 status_manager.go:895] &#34;</span>Failed to get status <span style=color:#ff79c6>for</span> pod<span style=color:#f1fa8c>&#34; podUID=&#34;</span>2c24b0c0e58d94f573d7e6e560e76f26<span style=color:#f1fa8c>&#34; pod=&#34;</span>kube-system/etcd-no
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>May <span style=color:#bd93f9>16</span> 23:06:27 node kubelet<span style=color:#ff79c6>[</span>3267<span style=color:#ff79c6>]</span>: I0516 23:06:27.854626    <span style=color:#bd93f9>3267</span> scope.go:117<span style=color:#ff79c6>]</span> <span style=color:#f1fa8c>&#34;RemoveContainer&#34;</span> <span style=color:#8be9fd;font-style:italic>containerID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;4ac91f035f22f6859e8b0b95884465fd00ea93838034ae9fc6202a2739beeaee&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>May <span style=color:#bd93f9>16</span> 23:06:27 node kubelet<span style=color:#ff79c6>[</span>3267<span style=color:#ff79c6>]</span>: E0516 23:06:27.854843    <span style=color:#bd93f9>3267</span> pod_workers.go:1301<span style=color:#ff79c6>]</span> <span style=color:#f1fa8c>&#34;Error syncing pod, skipping&#34;</span> <span style=color:#8be9fd;font-style:italic>err</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;failed to \&#34;StartContainer\&#34; for \&#34;kube-proxy\&#34; with CrashLoopBa&gt;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#f1fa8c>May 16 23:06:28 node kubelet[3267]: E0516 23:06:28.636402    3267 controller.go:145] &#34;</span>Failed to ensure lease exists, will retry<span style=color:#f1fa8c>&#34; err=&#34;</span>Get <span style=color:#f1fa8c>\&#34;</span>https://192.168.1.18:6443/apis/coordination.k8&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>May <span style=color:#bd93f9>16</span> 23:06:28 node kubelet<span style=color:#ff79c6>[</span>3267<span style=color:#ff79c6>]</span>: I0516 23:06:28.858703    <span style=color:#bd93f9>3267</span> scope.go:117<span style=color:#ff79c6>]</span> <span style=color:#f1fa8c>&#34;RemoveContainer&#34;</span> <span style=color:#8be9fd;font-style:italic>containerID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;3c72bf6c70703db94d7a7d06372d113ee924f44cc22619a3b12c2f7c78f6ced1&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>May <span style=color:#bd93f9>16</span> 23:06:28 node kubelet<span style=color:#ff79c6>[</span>3267<span style=color:#ff79c6>]</span>: E0516 23:06:28.858943    <span style=color:#bd93f9>3267</span> pod_workers.go:1301<span style=color:#ff79c6>]</span> <span style=color:#f1fa8c>&#34;Error syncing pod, skipping&#34;</span> <span style=color:#8be9fd;font-style:italic>err</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;failed to \&#34;StartContainer\&#34; for \&#34;kube-controller-manager\&#34; wit&gt;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#f1fa8c>May 16 23:06:29 node kubelet[3267]: E0516 23:06:29.064103    3267 kubelet.go:3117] &#34;</span>Container runtime network not ready<span style=color:#f1fa8c>&#34; networkReady=&#34;</span><span style=color:#8be9fd;font-style:italic>NetworkReady</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>false</span> reason:NetworkPluginNotReady mes
</span></span></code></pre></div><p>We can see it’s kubelet terminating the containers because it can’t connect to them. Thinking back, I did forget to install the Flannel network CNI.</p><h3 id=flannel>Flannel</h3><p>We apply the procedure from their website, which uses a kubectl command—but if the API server and etcd are unreachable, it can’t work.</p><p>I test it anyway while waiting for etcd to come up.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>david@node:~$ kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>namespace/kube-flannel created
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>serviceaccount/flannel created
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>clusterrole.rbac.authorization.k8s.io/flannel created
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>clusterrolebinding.rbac.authorization.k8s.io/flannel created
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>configmap/kube-flannel-cfg created
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>daemonset.apps/kube-flannel-ds created
</span></span></code></pre></div><p>We check the flannel pod—it’s still not healthy.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>david@node:~$ kubectl get pods --all-namespaces
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>NAMESPACE      NAME                           READY   STATUS             RESTARTS        AGE
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>kube-flannel   kube-flannel-ds-f2kgs          0/1     Pending            <span style=color:#bd93f9>0</span>               3m54s
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>kube-system    coredns-674b8bbfcf-4wsms       0/1     Pending            <span style=color:#bd93f9>0</span>               26m
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>kube-system    coredns-674b8bbfcf-fg6k4       0/1     Pending            <span style=color:#bd93f9>0</span>               26m
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>kube-system    etcd-node                      1/1     Running            <span style=color:#bd93f9>7</span> <span style=color:#ff79c6>(</span>9m53s ago<span style=color:#ff79c6>)</span>   27m
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>kube-system    kube-apiserver-node            1/1     Running            <span style=color:#bd93f9>9</span> <span style=color:#ff79c6>(</span>9m17s ago<span style=color:#ff79c6>)</span>   27m
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>kube-system    kube-controller-manager-node   0/1     CrashLoopBackOff   <span style=color:#bd93f9>8</span> <span style=color:#ff79c6>(</span>3m52s ago<span style=color:#ff79c6>)</span>   27m
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>kube-system    kube-proxy-wfzds               0/1     CrashLoopBackOff   <span style=color:#bd93f9>8</span> <span style=color:#ff79c6>(</span>65s ago<span style=color:#ff79c6>)</span>     26m
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>kube-system    kube-scheduler-node            0/1     CrashLoopBackOff   <span style=color:#bd93f9>8</span> <span style=color:#ff79c6>(</span>63s ago<span style=color:#ff79c6>)</span>     27m
</span></span></code></pre></div><p>While going through the Flannel documentation, they mention the following:</p><pre tabindex=0><code>Flannel requires the br_netfilter module to start and from version 1.30 kubeadm doesn&#39;t check if the module is installed and Flannel will not rightly start in case the module is missing.
</code></pre><p>So we load the module:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>david@node:~$ sudo modprobe br_netfilter
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>david@node:~$
</span></span></code></pre></div><p>We then check the status of the control plane pods:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>david@node:~$ kubectl get pods --all-namespaces
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>NAMESPACE      NAME                           READY   STATUS    RESTARTS         AGE
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>kube-flannel   kube-flannel-ds-f2kgs          1/1     Running   <span style=color:#bd93f9>0</span>                19m
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>kube-system    coredns-674b8bbfcf-4wsms       1/1     Running   <span style=color:#bd93f9>1</span> <span style=color:#ff79c6>(</span>62s ago<span style=color:#ff79c6>)</span>      42m
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>kube-system    coredns-674b8bbfcf-fg6k4       1/1     Running   <span style=color:#bd93f9>1</span> <span style=color:#ff79c6>(</span>62s ago<span style=color:#ff79c6>)</span>      42m
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>kube-system    etcd-node                      1/1     Running   <span style=color:#bd93f9>11</span> <span style=color:#ff79c6>(</span>3m56s ago<span style=color:#ff79c6>)</span>   42m
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>kube-system    kube-apiserver-node            1/1     Running   <span style=color:#bd93f9>14</span> <span style=color:#ff79c6>(</span>2m28s ago<span style=color:#ff79c6>)</span>   42m
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>kube-system    kube-controller-manager-node   1/1     Running   <span style=color:#bd93f9>12</span> <span style=color:#ff79c6>(</span>66s ago<span style=color:#ff79c6>)</span>     43m
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>kube-system    kube-proxy-wfzds               1/1     Running   <span style=color:#bd93f9>13</span> <span style=color:#ff79c6>(</span>82s ago<span style=color:#ff79c6>)</span>     42m
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>kube-system    kube-scheduler-node            1/1     Running   <span style=color:#bd93f9>13</span> <span style=color:#ff79c6>(</span>2m4s ago<span style=color:#ff79c6>)</span>    42m
</span></span></code></pre></div><p>That improves the situation, but the control plane is still crashing:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>david@node:~$ kubectl get pods --all-namespaces
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>NAMESPACE      NAME                           READY   STATUS             RESTARTS         AGE
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>kube-flannel   kube-flannel-ds-f2kgs          1/1     Running            <span style=color:#bd93f9>1</span> <span style=color:#ff79c6>(</span>28s ago<span style=color:#ff79c6>)</span>      20m
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>kube-system    coredns-674b8bbfcf-4wsms       0/1     CrashLoopBackOff   <span style=color:#bd93f9>1</span> <span style=color:#ff79c6>(</span>7s ago<span style=color:#ff79c6>)</span>       43m
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>kube-system    coredns-674b8bbfcf-fg6k4       0/1     CrashLoopBackOff   <span style=color:#bd93f9>1</span> <span style=color:#ff79c6>(</span>9s ago<span style=color:#ff79c6>)</span>       43m
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>kube-system    etcd-node                      1/1     Running            <span style=color:#bd93f9>11</span> <span style=color:#ff79c6>(</span>4m31s ago<span style=color:#ff79c6>)</span>   43m
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>kube-system    kube-apiserver-node            1/1     Running            <span style=color:#bd93f9>14</span> <span style=color:#ff79c6>(</span>3m3s ago<span style=color:#ff79c6>)</span>    43m
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>kube-system    kube-controller-manager-node   1/1     Running            <span style=color:#bd93f9>12</span> <span style=color:#ff79c6>(</span>101s ago<span style=color:#ff79c6>)</span>    44m
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>kube-system    kube-proxy-wfzds               0/1     CrashLoopBackOff   <span style=color:#bd93f9>13</span> <span style=color:#ff79c6>(</span>19s ago<span style=color:#ff79c6>)</span>     43m
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>kube-system    kube-scheduler-node            1/1     Running            <span style=color:#bd93f9>13</span> <span style=color:#ff79c6>(</span>2m39s ago<span style=color:#ff79c6>)</span>   43m
</span></span></code></pre></div><p>Let&rsquo;s dig in and review the logs for the flannel pod, let&rsquo;s check containers :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>david@node:~$ sudo crictl ps -a
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>CONTAINER           IMAGE               CREATED              STATE               NAME                      ATTEMPT             POD ID              POD                            NAMESPACE
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>badb8f8f7dfcf       398c985c0d950       About a minute ago   Exited              kube-scheduler            <span style=color:#bd93f9>18</span>                  ca4e01c9f17e9       kube-scheduler-node            kube-system
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>2e8eb3af1f25e       965b9dd4aa4c1       About a minute ago   Exited              kube-flannel              <span style=color:#bd93f9>8</span>                   911cf9207c530       kube-flannel-ds-f2kgs          kube-flannel
</span></span></code></pre></div><p>We see that the flannel container is still crashing, let&rsquo;s check the logs</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>david@node:~$ sudo crictl logs 2e8eb3af1f25e
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>I0516 21:58:33.687927       <span style=color:#bd93f9>1</span> main.go:211<span style=color:#ff79c6>]</span> CLI flags config: <span style=color:#ff79c6>{</span>etcdEndpoints:http://127.0.0.1:4001,http://127.0.0.1:2379 etcdPrefix:/coreos.com/network etcdKeyfile: etcdCertfile: etcdCAFile: etcdUsername: etcdPassword: version:false kubeSubnetMgr:true kubeApiUrl: kubeAnnotationPrefix:flannel.alpha.coreos.com kubeConfigFile: iface:<span style=color:#ff79c6>[]</span> ifaceRegex:<span style=color:#ff79c6>[]</span> ipMasq:true ifaceCanReach: subnetFile:/run/flannel/subnet.env publicIP: publicIPv6: subnetLeaseRenewMargin:60 healthzIP:0.0.0.0 healthzPort:0 iptablesResyncSeconds:5 iptablesForwardRules:true netConfPath:/etc/kube-flannel/net-conf.json setNodeNetworkUnavailable:true<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>W0516 21:58:33.688160       <span style=color:#bd93f9>1</span> client_config.go:618<span style=color:#ff79c6>]</span> Neither --kubeconfig nor --master was specified.  Using the inClusterConfig.  This might not work.
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>E0516 21:58:33.688898       <span style=color:#bd93f9>1</span> main.go:228<span style=color:#ff79c6>]</span> Failed to create SubnetManager: error retrieving pod spec <span style=color:#ff79c6>for</span> <span style=color:#f1fa8c>&#39;kube-flannel/kube-flannel-ds-f2kgs&#39;</span>: Get <span style=color:#f1fa8c>&#34;https://10.96.0.1:443/api/v1/namespaces/kube-flannel/pods/kube-flannel-ds-f2kgs&#34;</span>: dial tcp 10.96.0.1:443: connect: connection refused
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>david@node:~$ kubectl get svc kubernetes -n default
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span style=color:#ff79c6>(</span>S<span style=color:#ff79c6>)</span>   AGE
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   73m
</span></span></code></pre></div><p>While checking my containerd configuration <code>/etc/containerd/config.toml</code> I noticed that <code>version = 2</code> was missing, so I added it and restarted the service.
After waiting a little bit, then we have the cluster ready.</p><p>The issue was that the driver for cgroups needed to be the same between the kubelet and the containerd.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>david@node:~$ kubectl get pods --all-namespaces
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>NAMESPACE      NAME                           READY   STATUS    RESTARTS       AGE
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>kube-flannel   kube-flannel-ds-f2kgs          1/1     Running   <span style=color:#bd93f9>23</span> <span style=color:#ff79c6>(</span>32m ago<span style=color:#ff79c6>)</span>   12h
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>kube-system    coredns-674b8bbfcf-4wsms       1/1     Running   <span style=color:#bd93f9>16</span> <span style=color:#ff79c6>(</span>32m ago<span style=color:#ff79c6>)</span>   13h
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>kube-system    coredns-674b8bbfcf-fg6k4       1/1     Running   <span style=color:#bd93f9>16</span> <span style=color:#ff79c6>(</span>32m ago<span style=color:#ff79c6>)</span>   13h
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>kube-system    etcd-node                      1/1     Running   <span style=color:#bd93f9>34</span> <span style=color:#ff79c6>(</span>32m ago<span style=color:#ff79c6>)</span>   13h
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>kube-system    kube-apiserver-node            1/1     Running   <span style=color:#bd93f9>33</span> <span style=color:#ff79c6>(</span>32m ago<span style=color:#ff79c6>)</span>   13h
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>kube-system    kube-controller-manager-node   1/1     Running   <span style=color:#bd93f9>30</span> <span style=color:#ff79c6>(</span>32m ago<span style=color:#ff79c6>)</span>   13h
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>kube-system    kube-proxy-wfzds               1/1     Running   <span style=color:#bd93f9>36</span> <span style=color:#ff79c6>(</span>32m ago<span style=color:#ff79c6>)</span>   13h
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>kube-system    kube-scheduler-node            1/1     Running   <span style=color:#bd93f9>34</span> <span style=color:#ff79c6>(</span>32m ago<span style=color:#ff79c6>)</span>   13h
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>david@node:~$ kubectl get nodes
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>NAME   STATUS   ROLES           AGE   VERSION
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>node   Ready    control-plane   13h   v1.33.1
</span></span></code></pre></div><p>Control plane is now ready, by default, you can&rsquo;t run any workoad containers on the control plane, or you need to set the taint to allow it.</p><p>On the next post we will add a worker node to the cluster.</p></div></article><div class=blog-post-comments><div id=cactus-comments-thread><script>initComments({node:document.getElementById("cactus-comments-thread"),defaultHomeserverUrl:"https://matrix.cactus.chat:8448",serverName:"cactus.chat",siteName:"your_cactus_comments_sitename",commentSectionId:"/posts/k8s-part1-control-plane-installation-on-debian/"})</script></div></div><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Main</a></li><li><a href=/posts>Writings</a></li><li><a href=/tags>Tags</a></li><li><a href=/about>About</a></li><li><a href=/posts/>Posts</a></li></ul></div><div id=toc-footer style=display:none><nav id=TableOfContents><ul><li><a href=#rationale>Rationale</a></li><li><a href=#lets-get-started>Let&rsquo;s get started</a></li><li><a href=#pre-requisites>Pre-requisites</a><ul><li><a href=#disable-swap>Disable swap</a></li><li><a href=#installing-runtime>Installing runtime</a></li></ul></li><li><a href=#installing-with-kubeadm>Installing with Kubeadm</a><ul><li><a href=#install-using-the-kubernetes-repo>Install using the Kubernetes repo</a></li><li><a href=#cluster-creation>Cluster creation</a></li><li><a href=#flannel>Flannel</a></li></ul></li></ul></nav></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fdavmig.github.io%2fposts%2fk8s-part1-control-plane-installation-on-debian%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fdavmig.github.io%2fposts%2fk8s-part1-control-plane-installation-on-debian%2f&text=Installation%20of%20Kubernetes%20on%20Debian%20Part%201%20-%20Control%20Plane" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fdavmig.github.io%2fposts%2fk8s-part1-control-plane-installation-on-debian%2f&title=Installation%20of%20Kubernetes%20on%20Debian%20Part%201%20-%20Control%20Plane" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fdavmig.github.io%2fposts%2fk8s-part1-control-plane-installation-on-debian%2f&is_video=false&description=Installation%20of%20Kubernetes%20on%20Debian%20Part%201%20-%20Control%20Plane" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Installation%20of%20Kubernetes%20on%20Debian%20Part%201%20-%20Control%20Plane&body=Check out this article: https%3a%2f%2fdavmig.github.io%2fposts%2fk8s-part1-control-plane-installation-on-debian%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fdavmig.github.io%2fposts%2fk8s-part1-control-plane-installation-on-debian%2f&title=Installation%20of%20Kubernetes%20on%20Debian%20Part%201%20-%20Control%20Plane" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fdavmig.github.io%2fposts%2fk8s-part1-control-plane-installation-on-debian%2f&title=Installation%20of%20Kubernetes%20on%20Debian%20Part%201%20-%20Control%20Plane" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fdavmig.github.io%2fposts%2fk8s-part1-control-plane-installation-on-debian%2f&name=Installation%20of%20Kubernetes%20on%20Debian%20Part%201%20-%20Control%20Plane&description=%3ch2%20id%3d%22rationale%22%3eRationale%3c%2fh2%3e%0a%3cp%3eAt%20work%2c%20we%20are%20currently%20deploying%20GKEs%20for%20our%20applications.%20Today%2c%20containerization%20is%20no%20longer%20something%20I%20see%20as%20optional%20but%20a%20necessity%20due%20to%20the%20value%20it%20provides%e2%80%94though%20it%26rsquo%3bs%20often%20necessary%20to%20work%20on%20team%20organization%20first%20to%20get%20the%20most%20out%20of%20it%2c%20but%20that%26rsquo%3bs%20a%20topic%20for%20another%20post.%3c%2fp%3e%0a%3cp%3eHowever%2c%20mastering%20such%20a%20system%20is%20not%20within%20everyone%26rsquo%3bs%20reach.%20Implementing%20technical%20governance%20around%20this%20system%20is%20no%20easy%20task%2c%20and%20those%20who%20implement%20it%20generally%20agree%e2%80%94it%26rsquo%3bs%20complex%20and%20requires%20real%20expertise%20to%20design%20and%20deploy%20the%20various%20stacks%20with%20technology%20choices%20suited%20to%20the%20context.%3c%2fp%3e" aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fdavmig.github.io%2fposts%2fk8s-part1-control-plane-installation-on-debian%2f&t=Installation%20of%20Kubernetes%20on%20Debian%20Part%201%20-%20Control%20Plane" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick='return $("#nav-footer").toggle(),!1' aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=toc-toggle class=icon href=# onclick='return $("#toc-footer").toggle(),!1' aria-label=TOC><i class="fas fa-list fa-lg" aria-hidden=true></i> TOC</a>
<a id=share-toggle class=icon href=# onclick='return $("#share-footer").toggle(),!1' aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2025 Zaft Memory Core</div><div class=footer-right><nav><ul><li><a href=/>Main</a></li><li><a href=/posts>Writings</a></li><li><a href=/tags>Tags</a></li><li><a href=/about>About</a></li><li><a href=/posts/>Posts</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script><script src=/js/code-copy.js></script></html>